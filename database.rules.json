{
  "rules": {
    // ============================================
    // MESSAGES (Real-time chat)
    // ============================================
    // Structure: /messages/{conversationId}/{messageId}
    // Story 5.7: Enforce creator-only channel restrictions
    "messages": {
      "$conversationId": {
        // Only participants of the conversation can read messages
        ".read": "auth != null && root.child('conversations').child($conversationId).child('participantIDs').child(auth.uid).exists()",
        "$messageId": {
          // Story 5.7: Check if channel is creator-only, and if so, only allow creator to write
          // If isCreatorOnly is true, check if user is creator (userType == 'creator')
          // Otherwise, allow any participant to write
          ".write": "auth != null && (!data.exists() || data.child('senderId').val() == auth.uid) && (root.child('conversations').child($conversationId).child('isCreatorOnly').val() != true || root.child('users').child(auth.uid).child('userType').val() == 'creator')"
        }
      }
    },

    // ============================================
    // CONVERSATIONS (Metadata and ephemeral data)
    // ============================================
    // Structure: /conversations/{conversationId}
    "conversations": {
      // Allow authenticated users to read all conversations
      // Client-side filtering ensures users only see conversations they participate in
      ".read": "auth != null",

      "$conversationId": {
        // Participants can read the conversation
        ".read": "auth != null && data.child('participantIDs').child(auth.uid).exists()",

        // Participants can write (create/update conversation)
        // Allow creation if user is in new participantIDs
        // Allow update if user is already a participant
        ".write": "auth != null && ((!data.exists() && newData.child('participantIDs').child(auth.uid).exists()) || (data.exists() && data.child('participantIDs').child(auth.uid).exists()))",

        // Typing indicators
        // Structure: /conversations/{conversationId}/typing/{userId}
        "typing": {
          "$userId": {
            ".read": "auth != null",
            ".write": "auth != null && $userId == auth.uid"
          }
        }
      }
    },

    // ============================================
    // USER PRESENCE (Story 2.8)
    // ============================================
    // Structure: /userPresence/{uid}/online, /userPresence/{uid}/lastSeen
    "userPresence": {
      "$uid": {
        // Anyone authenticated can read presence status
        ".read": "auth != null",

        // Only the user can update their own presence
        ".write": "auth != null && auth.uid == $uid",

        // Validate presence data structure
        "online": {
          ".validate": "newData.isBoolean()"
        },

        "lastSeen": {
          ".validate": "newData.isNumber()"
        }
      }
    },

    // ============================================
    // LEGACY PRESENCE (Keep for backward compatibility)
    // ============================================
    "presence": {
      "$userId": {
        ".read": "auth != null",
        ".write": "auth != null && $userId == auth.uid"
      }
    },

    // ============================================
    // USERS (Profile data for conversation validation)
    // ============================================
    // Structure: /users/{uid}
    "users": {
      "$uid": {
        // Anyone authenticated can read user profiles
        ".read": "auth != null",

        // Only the user can write their own profile
        ".write": "auth != null && auth.uid == $uid",

        // Validate required fields and types
        ".validate": "newData.hasChildren(['email', 'displayName', 'userType', 'isPublic'])",

        "email": {
          ".validate": "newData.isString()"
        },

        "displayName": {
          ".validate": "newData.isString()"
        },

        "profilePictureURL": {
          ".validate": "newData.isString()"
        },

        // userType is immutable - can only be set on creation
        "userType": {
          ".validate": "newData.isString() && (newData.val() == 'creator' || newData.val() == 'fan') && (!data.exists() || newData.val() == data.val())"
        },

        // isPublic is immutable - can only be set on creation
        "isPublic": {
          ".validate": "newData.isBoolean() && (!data.exists() || newData.val() == data.val())"
        },

        "createdAt": {
          ".validate": "newData.isNumber()"
        },

        "updatedAt": {
          ".validate": "newData.isNumber()"
        }
      }
    },

    // ============================================
    // DEFAULT DENY ALL
    // ============================================
    ".read": false,
    ".write": false
  }
}
