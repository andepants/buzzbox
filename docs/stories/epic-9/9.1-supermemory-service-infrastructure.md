# Story 9.1: Supermemory Service Infrastructure

**Epic:** Epic 9 - Supermemory RAG Integration
**Story ID:** 9.1
**Priority:** P1 (High)
**Estimated Time:** 3-4 hours
**Dependencies:** None
**Status:** Draft

---

## ðŸ“– User Story

**As a** developer integrating RAG capabilities,
**I want** a robust Supermemory API service layer,
**So that** I can add and search memories with proper authentication, error handling, and Swift concurrency patterns.

---

## ðŸŽ¯ Acceptance Criteria

### Functional Requirements

1. **Service Implementation**
   - [ ] Create `SupermemoryService.swift` in `Core/Services/` directory
   - [ ] Implement singleton pattern with `shared` instance
   - [ ] Use `@MainActor` for thread safety
   - [ ] Implement `ObservableObject` protocol for state observation

2. **Add Memory Method**
   - [ ] Implement `addMemory(content: String, metadata: [String: String]?) async throws`
   - [ ] POST to `https://v2.api.supermemory.ai/add`
   - [ ] Include `x-api-key` header from Keychain
   - [ ] Send JSON payload: `{"content": "...", "metadata": {...}}`
   - [ ] Handle 200-299 status codes as success
   - [ ] Throw descriptive errors for failures

3. **Search Memories Method**
   - [ ] Implement `searchMemories(query: String, limit: Int = 3) async throws -> [Memory]`
   - [ ] Use appropriate endpoint (GET or POST based on API docs)
   - [ ] Include `x-api-key` header from Keychain
   - [ ] Parse response into `Memory` model array
   - [ ] Apply 2-second timeout with graceful fallback
   - [ ] Return empty array on timeout (don't throw)

4. **Configuration Management**
   - [ ] Implement `isEnabled: Bool` computed property
   - [ ] Check for API key presence in Keychain
   - [ ] Store API key using `KeychainHelper.save(key: "supermemory_api_key", value: String)`
   - [ ] Retrieve API key using `KeychainHelper.get(key: "supermemory_api_key")`

5. **Memory Model**
   - [ ] Create `Memory` struct in `Core/Models/Memory.swift`
   - [ ] Properties: `id: String`, `content: String`, `metadata: [String: String]?`, `score: Double?`
   - [ ] Conform to `Codable` and `Identifiable`

### Technical Requirements

6. **Swift Concurrency**
   - [ ] Use `async/await` for all API calls (no completion handlers)
   - [ ] Use `URLSession.shared.data(for:)` for HTTP requests
   - [ ] Properly handle `Task` cancellation

7. **Error Handling**
   - [ ] Define `SupermemoryError` enum with cases:
     - `notConfigured` - No API key found
     - `invalidResponse` - Non-200 status code
     - `decodingError(Error)` - JSON parsing failed
     - `networkError(Error)` - URLSession error
     - `timeout` - Request exceeded timeout
   - [ ] Throw specific errors (don't swallow exceptions)

8. **Networking**
   - [ ] Use native `URLSession` (no external dependencies)
   - [ ] Set `Content-Type: application/json` header
   - [ ] Use `JSONEncoder`/`JSONDecoder` for serialization
   - [ ] Implement proper URL construction

### Quality Requirements

9. **Code Quality**
   - [ ] Add `///` doc comments to all public methods
   - [ ] Follow existing `AIService.swift` patterns
   - [ ] Keep file under 300 lines
   - [ ] Use descriptive variable names

10. **Testing**
    - [ ] Service initializes correctly
    - [ ] `isEnabled` returns false when no API key
    - [ ] `isEnabled` returns true when API key exists
    - [ ] Methods throw `notConfigured` error when disabled

---

## ðŸ”§ Technical Implementation Notes

### API Documentation (Confirmed)

**Base URL:** `https://v2.api.supermemory.ai`

**Add Memory Endpoint:**
```bash
POST /add
Headers:
  x-api-key: YOUR_API_KEY
  Content-Type: application/json
Body:
{
  "content": "Q: When is your next livestream?\nA: Saturday at 3pm EST!",
  "metadata": {
    "conversationID": "abc123",
    "timestamp": "2025-01-15T10:30:00Z",
    "category": "scheduling"
  }
}
```

**Search Memory Endpoint:**
```bash
# Note: Exact endpoint to be confirmed during implementation
# Options: GET /search?q=query&limit=3 OR POST /search
# Use SDK documentation pattern: client.search.documents(q="query")
```

### File Structure

```
buzzbox/
â”œâ”€â”€ Core/
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â””â”€â”€ Memory.swift          # NEW: Memory data model
â”‚   â””â”€â”€ Services/
â”‚       â”œâ”€â”€ SupermemoryService.swift  # NEW: Main service
â”‚       â””â”€â”€ AIService.swift           # REFERENCE: Similar patterns
```

### Code Template (Starter)

```swift
import Foundation

/// Service for managing Supermemory API integration
/// Provides RAG (Retrieval-Augmented Generation) capabilities
@MainActor
final class SupermemoryService: ObservableObject {
    static let shared = SupermemoryService()

    private let baseURL = "https://v2.api.supermemory.ai"
    private let keychainKey = "supermemory_api_key"

    private init() {}

    /// Check if Supermemory is configured
    var isEnabled: Bool {
        // TODO: Check keychain for API key
        return false
    }

    /// Add a memory to Supermemory
    func addMemory(content: String, metadata: [String: String]? = nil) async throws {
        // TODO: Implement POST /add
    }

    /// Search memories by query
    func searchMemories(query: String, limit: Int = 3) async throws -> [Memory] {
        // TODO: Implement search endpoint
        return []
    }
}

/// Error types for Supermemory operations
enum SupermemoryError: LocalizedError {
    case notConfigured
    case invalidResponse(statusCode: Int)
    case decodingError(Error)
    case networkError(Error)
    case timeout

    var errorDescription: String? {
        switch self {
        case .notConfigured:
            return "Supermemory API key not configured"
        case .invalidResponse(let code):
            return "Invalid response: \(code)"
        case .decodingError(let error):
            return "Decoding failed: \(error.localizedDescription)"
        case .networkError(let error):
            return "Network error: \(error.localizedDescription)"
        case .timeout:
            return "Request timeout"
        }
    }
}
```

### Memory Model Template

```swift
import Foundation

/// Represents a memory retrieved from Supermemory
struct Memory: Identifiable, Codable {
    let id: String
    let content: String
    let metadata: [String: String]?
    let score: Double?

    enum CodingKeys: String, CodingKey {
        case id
        case content
        case metadata
        case score
    }
}
```

---

## ðŸ”— Related Files

- **Reference:** `Core/Services/AIService.swift` - Follow similar patterns for API service
- **Reference:** `Core/Utilities/KeychainHelper.swift` - API key storage/retrieval
- **New:** `Core/Models/Memory.swift` - Memory data model
- **New:** `Core/Services/SupermemoryService.swift` - Main service file

---

## ðŸ“‹ Definition of Done

- [ ] `SupermemoryService.swift` created with all required methods
- [ ] `Memory.swift` model created with proper Codable conformance
- [ ] All acceptance criteria met and tested
- [ ] Code compiles without warnings
- [ ] Doc comments added to all public APIs
- [ ] Follows Swift 6 concurrency patterns
- [ ] Keychain integration working for API key storage
- [ ] Error handling implemented with specific error types
- [ ] Code reviewed against existing service patterns

---

## âš ï¸ Important Notes

1. **Graceful Degradation:** Service must fail gracefully if API key is missing
2. **No Blocking:** Never block the main thread waiting for API responses
3. **Timeout Handling:** Search must timeout after 2 seconds to prevent UI hangs
4. **Security:** API key stored in Keychain, never hardcoded
5. **Future-Proofing:** Design allows for easy addition of other Supermemory endpoints

---

## ðŸ” Testing Guidance

**Manual Testing Steps:**
1. Run app without API key â†’ `isEnabled` should be false
2. Add API key via Settings â†’ `isEnabled` should be true
3. Call `addMemory()` with test content â†’ verify network request in logs
4. Call `searchMemories()` with query â†’ verify results returned
5. Test with invalid API key â†’ verify proper error thrown
6. Test with network disconnected â†’ verify timeout handling

**Edge Cases:**
- Empty content string
- Nil metadata
- Very long content (>10KB)
- Network interruption mid-request
- API rate limiting (429 status)

---

**Created by:** Sarah (PO Agent)
**Date:** 2025-10-26
**Updated API Info:** Confirmed from supermemory.ai/docs (2025)
