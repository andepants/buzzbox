# Story 6.1: Firebase Cloud Functions Setup

## Status
Draft

## Story
**As a** developer,
**I want** to set up Firebase Cloud Functions so I can deploy AI workflows,
**so that** I can build serverless AI features that process messages and generate smart replies.

## Acceptance Criteria
1. Firebase Functions initialized in project (`functions/` directory)
2. OpenAI SDK installed (`npm install openai`)
3. Firebase Admin SDK configured
4. Environment variables configured (OpenAI API key)
5. Test function deployed and working
6. Firebase Emulator Suite set up for local testing

## Tasks / Subtasks

- [ ] Verify Firebase project configuration
  - [ ] Run `firebase projects:list` to see available projects
  - [ ] Run `firebase use` to check currently selected project
  - [ ] If not set, run `firebase use --add` and select correct project
  - [ ] Verify `.firebaserc` file exists with correct project ID

- [ ] Initialize or verify Firebase Functions (AC: 1)
  - [ ] Check if `functions/` directory already exists
  - [ ] If exists: skip `firebase init functions` (already initialized)
  - [ ] If not exists: Run `firebase init functions` from project root
  - [ ] Choose TypeScript as the language
  - [ ] Choose ESLint for code quality
  - [ ] Verify `functions/package.json` exists with proper structure

- [ ] Install required dependencies (AC: 2, 3)
  - [ ] Navigate to `functions/` directory
  - [ ] Run `npm install openai` for OpenAI SDK
  - [ ] Verify `firebase-admin` and `firebase-functions` are in package.json
  - [ ] Note: `firebase-admin` already includes Firestore access, no need for separate package

- [ ] Configure Firebase Admin SDK (AC: 3)
  - [ ] Initialize Admin SDK in `functions/src/index.ts`
  - [ ] Add `import * as admin from 'firebase-admin'`
  - [ ] Add `admin.initializeApp()` at top of file
  - [ ] Verify Admin SDK credentials are auto-configured for production

- [ ] Set up environment variables (AC: 4)
  - [ ] Use environment configuration from Story 6.0
  - [ ] Update `functions/src/index.ts` to access `process.env.OPENAI_API_KEY`
  - [ ] Initialize OpenAI client with API key from environment

- [ ] Create test function with OpenAI verification (AC: 5)
  - [ ] Create `helloWorld` HTTP function in `functions/src/index.ts`
  - [ ] Function should initialize OpenAI client
  - [ ] Make minimal test call: `openai.chat.completions.create()` with max_tokens: 1
  - [ ] Catch errors and return connectivity status
  - [ ] Function returns JSON: `{ message: "Firebase Functions + OpenAI ready!", openaiConnected: true }`
  - [ ] Export function for deployment

- [ ] Deploy test function to production (AC: 5)
  - [ ] Run `firebase deploy --only functions`
  - [ ] Verify deployment succeeds
  - [ ] Test deployed function via URL from deployment output
  - [ ] Check logs: `firebase functions:log`

- [ ] Set up Firebase Emulator Suite (AC: 6)
  - [ ] Run `firebase init emulators`
  - [ ] Select Functions emulator
  - [ ] Configure emulator ports (default: 5001)
  - [ ] Run `firebase emulators:start --only functions`
  - [ ] Test `helloWorld` function locally via `http://localhost:5001`

- [ ] Verify package.json configuration
  - [ ] Confirm Node.js version is 18 in `engines` section
  - [ ] Add deployment script: `"deploy": "firebase deploy --only functions"`
  - [ ] Add logs script: `"logs": "firebase functions:log"`
  - [ ] Verify all dependencies have correct versions

## Dev Notes

### Architecture Context

**Cloud Functions Overview** [Source: architecture/system-architecture.md#3.1]
- Cloud Functions run on Node.js 18
- 5 Core Functions will be built in subsequent stories:
  1. `onMessageCreated` - Auto-categorization (Story 6.2)
  2. `generateSmartReplyCallable` - Smart replies (Story 6.4)
  3. `detectFAQCallable` - FAQ matching (Story 6.3)
  4. `analyzeSentimentCallable` - Sentiment analysis (Story 6.2)
  5. `scoreOpportunityCallable` - Business opportunity scoring (Story 6.2)

**Technology Stack** [Source: architecture/technology-stack.md#2.2]
- Serverless: Cloud Functions (Node.js 18)
- Firebase Admin SDK 12.0+
- Firebase Functions SDK 5.0+
- OpenAI SDK 4.0+

**AI Services** [Source: architecture/technology-stack.md#2.3]
- Primary AI: OpenAI GPT-4 (via Cloud Functions)
- All AI processing happens server-side
- OpenAI client initialized with API key from environment

**Deployment** [Source: architecture/deployment-architecture.md#9.4]
- Deploy via Firebase CLI: `firebase deploy --only functions --project sorted-prod`
- Set environment variables via Firebase Secrets (already done in Story 6.0)
- Environment variables accessible via `process.env`

### File Locations

**Cloud Functions Structure:**
```
functions/
├── src/
│   └── index.ts          # Main entry point (create test function here)
├── .env                  # Local environment variables (from Story 6.0)
├── .env.example          # Template (from Story 6.0)
├── .gitignore           # Ensure .env is ignored
├── package.json         # Dependencies and scripts
├── tsconfig.json        # TypeScript configuration
└── .eslintrc.js         # ESLint configuration
```

**Test Function Implementation:**

Create in `functions/src/index.ts`:
```typescript
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';
import OpenAI from 'openai';

admin.initializeApp();

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// Test function
export const helloWorld = functions.https.onRequest((request, response) => {
  response.json({ message: "Firebase Functions + OpenAI ready!" });
});
```

### Dependencies Configuration

**Required package.json entries:**
```json
{
  "scripts": {
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "18"
  },
  "dependencies": {
    "firebase-admin": "^12.0.0",
    "firebase-functions": "^5.0.0",
    "openai": "^4.0.0"
  },
  "devDependencies": {
    "typescript": "^5.0.0",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "eslint": "^8.0.0"
  }
}
```

### Testing

**Local Testing with Emulator:**
1. Start emulator: `firebase emulators:start --only functions`
2. Test endpoint: `curl http://localhost:5001/[PROJECT-ID]/us-central1/helloWorld`
3. Verify response: `{ "message": "Firebase Functions + OpenAI ready!" }`

**Production Testing:**
1. Deploy: `firebase deploy --only functions`
2. Test via deployment URL (shown in deployment output)
3. Check logs: `firebase functions:log`
4. Verify no errors in logs

**Testing Standards** [Source: architecture/testing-strategy.md - assumed]
- Manual verification via deployment and testing
- No unit tests needed for infrastructure setup
- Integration testing via deployed function endpoint

### Important Notes

- This story sets up the foundation for all AI features in Epic 6
- After completion, subsequent stories will add specific AI functions
- The test function verifies that:
  - Firebase Functions deployment works
  - TypeScript compilation succeeds
  - OpenAI SDK is accessible
  - Environment variables are configured correctly
- Emulator setup enables fast local development without deploying

### Prerequisites

- Story 6.0 (Environment Configuration) must be complete
- Firebase CLI must be installed globally: `npm install -g firebase-tools`
- Authenticated with Firebase: `firebase login`
- Firebase project must exist and be selected

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-22 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be populated by dev agent*

### Debug Log References

*To be populated by dev agent*

### Completion Notes

*To be populated by dev agent*

### File List

*To be populated by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
