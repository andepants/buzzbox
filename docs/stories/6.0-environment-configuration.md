# Story 6.0: Environment Configuration

## Status
Draft

## Story
**As a** developer,
**I want** to configure environment variables and constants so Cloud Functions can access OpenAI and identify the creator,
**so that** the AI-powered inbox features can authenticate with external services and target the correct user.

## Acceptance Criteria
1. Creator UID constant defined
2. OpenAI API key configured via environment variable
3. `.env` file created for local development
4. `.env.example` file created for documentation
5. Environment variables accessible in Cloud Functions
6. Production deployment configured with Firebase secrets

## Tasks / Subtasks

- [ ] Verify development environment prerequisites
  - [ ] Check Firebase CLI installed: `firebase --version`
  - [ ] Check Firebase authentication status: `firebase login:list`
  - [ ] If not authenticated, run: `firebase login`
  - [ ] Verify Node.js version 18+ installed: `node --version`

- [ ] Verify and define Creator UID constant (AC: 1)
  - [ ] Andrew's Firebase Auth UID should be: `UoLk9GtxDaaYGlI8Ah6RnCbXXbf2`
  - [ ] Verify UID in Firebase Console > Authentication > Users
  - [ ] Confirm the email matches: andrewsheim@gmail.com
  - [ ] Create constant in Cloud Functions code: `const CREATOR_UID = 'UoLk9GtxDaaYGlI8Ah6RnCbXXbf2'`
  - [ ] Document the UID source in code comments

- [ ] Verify or update .gitignore for security (AC: 4)
  - [ ] Check if `functions/.gitignore` already exists
  - [ ] Verify it includes `.env` and `.env.local`
  - [ ] If missing, add these entries
  - [ ] Run `git status` to verify no `.env` files are tracked

- [ ] Create local development environment file (AC: 3)
  - [ ] Create `functions/.env` file
  - [ ] Add `OPENAI_API_KEY=sk-proj-your-key-here`
  - [ ] Add `FIREBASE_PROJECT_ID=your-project-id`
  - [ ] Verify `.env` is in `.gitignore`

- [ ] Create environment documentation file (AC: 4)
  - [ ] Create `functions/.env.example` with template values
  - [ ] Add comments explaining where to get each value
  - [ ] Include links to OpenAI API keys page and Firebase Console

- [ ] Configure production secrets (AC: 6)
  - [ ] Run `firebase functions:secrets:set OPENAI_API_KEY`
  - [ ] Enter production OpenAI API key securely
  - [ ] Verify secret is accessible via `process.env.OPENAI_API_KEY`

- [ ] Verify Firebase Functions dependencies (AC: 5)
  - [ ] Check `functions/package.json` has `firebase-admin: ^12.0.0`
  - [ ] Check `functions/package.json` has `firebase-functions: ^5.0.0`
  - [ ] Check `functions/package.json` has `openai: ^4.0.0`
  - [ ] Verify Node.js version is set to 18 in `engines`

- [ ] Test environment configuration
  - [ ] Create test function that verifies OpenAI connectivity
  - [ ] Test function should attempt to initialize OpenAI client
  - [ ] Make minimal API call (max_tokens: 1) to verify key works
  - [ ] Return JSON: `{ message: "Ready", openaiConfigured: true, creatorUid: CREATOR_UID }`
  - [ ] Deploy test function to production
  - [ ] Call function and verify successful response
  - [ ] Check function logs: `firebase functions:log`
  - [ ] Delete or comment out test function after verification

## Dev Notes

### Architecture Context

**Cloud Functions Environment** [Source: architecture/ai-integration-architecture.md#6.2]
- Environment Variables must include:
  - `OPENAI_API_KEY`: Stored in Cloud Functions config (never in iOS app)
  - `SUPERMEMORY_API_KEY`: Stored in Cloud Functions config (not needed for this story)
  - `FIREBASE_*`: Admin SDK credentials (auto-configured)

**Firebase Backend** [Source: architecture/technology-stack.md#2.2]
- Serverless: Cloud Functions (Node.js 18)
- All AI processing happens server-side via Cloud Functions
- OpenAI API calls are made from Cloud Functions, never from iOS app

**Deployment Strategy** [Source: architecture/deployment-architecture.md#9.4]
- Cloud Functions deployed via Firebase CLI
- Environment variables set via `firebase functions:config:set`
- Production deployment command: `firebase deploy --only functions --project sorted-prod`

**Creator Identification** [Source: docs/prd/epic-6-ai-powered-creator-inbox.md]
- Andrew's Firebase Auth UID: `UoLk9GtxDaaYGlI8Ah6RnCbXXbf2`
- This UID is used to identify messages sent TO the creator (for AI processing)
- Only messages to the creator trigger AI categorization/sentiment analysis

### File Locations

**Cloud Functions Directory:**
- `functions/` - Root directory for all Cloud Functions code
- `functions/.env` - Local development environment variables (NEVER commit)
- `functions/.env.example` - Template for environment setup (commit this)
- `functions/.gitignore` - Must include `.env` and `.env.local`
- `functions/package.json` - Dependencies and Node.js version configuration
- `functions/src/index.ts` - Main entry point for Cloud Functions

### Security Notes

**Critical Security Rules:**
1. NEVER commit `.env` files to git
2. NEVER hardcode API keys in source code
3. Use Firebase Secrets for production (`firebase functions:secrets:set`)
4. Local development uses `.env` file (local only)
5. Production uses `process.env` (Firebase Secrets)

**Why This Matters:**
- OpenAI API keys are sensitive and cost money if leaked
- Creator UID identifies the single creator (Andrew) in the platform
- All AI features depend on these configurations being correct

### Testing

**Verification Steps:**
1. Create a simple test Cloud Function that logs environment variables
2. Deploy to production Firebase
3. Check logs to confirm variables are accessible
4. Delete test function after verification

**Testing Standards** [Source: architecture/testing-strategy.md - assumed standard practice]
- No unit tests needed for environment configuration
- Manual verification via deployment and logs is sufficient
- Integration testing happens in Story 6.1 (Firebase Cloud Functions Setup)

### Important Notes

- This is a prerequisite story for ALL subsequent Epic 6 stories
- No iOS code changes needed in this story
- Focus is purely on backend/Cloud Functions environment setup
- After completion, Stories 6.1-6.9 can access OpenAI and creator UID

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-22 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be populated by dev agent*

### Debug Log References

*To be populated by dev agent*

### Completion Notes

*To be populated by dev agent*

### File List

*To be populated by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
