# Story 6.3.5: FAQ Auto-Responder iOS Integration

## Status
Draft

## Story
**As a** fan,
**I want** my FAQ questions automatically answered when I message Andrew,
**so that** I get instant responses to common questions without waiting.

## Acceptance Criteria
1. iOS calls checkFAQ Cloud Function when message is sent to creator
2. FAQ check only happens for messages TO the creator (not from creator)
3. Auto-response is sent immediately if FAQ is matched
4. Auto-response is marked with `isAIGenerated: true`
5. Auto-response appears in chat with AI badge
6. FAQ check failures don't block message sending
7. User sees both their question and the auto-response

## Tasks / Subtasks

- [ ] Verify required files and dependencies (prerequisite)
  - [ ] Confirm AIService.swift exists with checkFAQ method (from Story 6.5)
  - [ ] Confirm MessageThreadViewModel or equivalent exists
  - [ ] Confirm ConversationService.swift exists
  - [ ] Document actual file locations if different

- [ ] Add CREATOR_UID constant to iOS codebase
  - [ ] Create `buzzbox/Core/Utilities/Constants.swift` if doesn't exist
  - [ ] Add public constant: `let CREATOR_UID = "UoLk9GtxDaaYGlI8Ah6RnCbXXbf2"`
  - [ ] Make accessible throughout app
  - [ ] This matches CREATOR_UID from Cloud Functions (Story 6.0)

- [ ] Integrate FAQ check in message receiving flow
  - [ ] Open `buzzbox/Core/Services/ConversationService.swift` or equivalent
  - [ ] Find method that handles incoming messages (likely `observeMessages` or similar)
  - [ ] Add @EnvironmentObject or inject AIService
  - [ ] When new message arrives, check if it's TO the creator
  - [ ] Check: `message.receiverId == CREATOR_UID`
  - [ ] If true, proceed to FAQ check

- [ ] Call checkFAQ Cloud Function
  - [ ] Import AIService in appropriate ViewModel
  - [ ] Call `aiService.checkFAQ(message.text)` asynchronously
  - [ ] Wrap in Task for async/await
  - [ ] Handle response: check `isFAQ` boolean
  - [ ] If `isFAQ: false`, do nothing (no FAQ match)
  - [ ] If `isFAQ: true`, proceed to auto-send response

- [ ] Auto-send FAQ response
  - [ ] Extract `answer` from FAQResponse
  - [ ] Call existing send message method
  - [ ] Set `senderID` to CREATOR_UID (response from creator)
  - [ ] Set `receiverId` to original message sender
  - [ ] Set `isAIGenerated: true` (marks as AI response)
  - [ ] Set `text` to FAQ answer
  - [ ] Message appears immediately in conversation

- [ ] Add error handling (AC: 6)
  - [ ] Wrap FAQ check in do-catch block
  - [ ] On error, log to console: `print("FAQ check failed: \(error)")`
  - [ ] Don't show error to user (silent failure)
  - [ ] Original message still sends successfully
  - [ ] Note: AIService.checkFAQ already fails silently (from Story 6.5)

- [ ] Prevent FAQ check on creator's own messages
  - [ ] Add check: only run FAQ logic if message sender is NOT creator
  - [ ] Check: `message.senderId != CREATOR_UID`
  - [ ] This prevents infinite loops (creator messages to fans don't trigger FAQ)
  - [ ] Only fan messages TO creator trigger FAQ check

- [ ] Test FAQ auto-response flow (AC: 1-7)
  - [ ] Build and run app
  - [ ] Login as fan account (not creator account)
  - [ ] Send FAQ question to creator: "What time do you stream?"
  - [ ] Verify FAQ response appears within 1-2 seconds
  - [ ] Verify response has AI badge (from Story 6.7)
  - [ ] Verify both question and response are visible
  - [ ] Send non-FAQ question: "Random question here"
  - [ ] Verify NO auto-response is sent

- [ ] Test edge cases
  - [ ] Empty message: verify FAQ check doesn't crash
  - [ ] Very long message: verify FAQ check handles it
  - [ ] Multiple rapid messages: verify FAQ checks don't interfere
  - [ ] Network error: verify silent failure works
  - [ ] Creator sends message: verify no FAQ check happens

## Dev Notes

### Architecture Context

**MVVM Integration** [Source: architecture/application-layers.md#5.1]
- ViewModel orchestrates Service layer calls
- ViewModel handles async operations with Task
- Service layer (AIService) makes Cloud Function calls
- View observes ViewModel for UI updates

**Message Flow** [Source: architecture/data-architecture.md#4.4]
- Messages written to SwiftData first
- Synced to RTDB in background
- RTDB observers receive updates
- SwiftData change notifications update UI

### File Locations

**Files to Modify:**
- `buzzbox/Core/Utilities/Constants.swift` - Add CREATOR_UID (create if needed)
- `buzzbox/Core/Services/ConversationService.swift` - Add FAQ check logic
- OR `buzzbox/Features/Messages/ViewModels/MessageThreadViewModel.swift` - Depending on architecture

**Files to Reference:**
- `buzzbox/Core/Services/AIService.swift` - checkFAQ method (from Story 6.5)
- `buzzbox/Core/Models/MessageEntity.swift` - isAIGenerated field (from Story 6.6)

### Implementation Template

**Constants.swift:**
```swift
import Foundation

/// Global constants for the application
public struct Constants {
    /// Creator's Firebase Auth UID (Andrew Heim)
    /// This matches CREATOR_UID from Cloud Functions
    public static let CREATOR_UID = "UoLk9GtxDaaYGlI8Ah6RnCbXXbf2"
}
```

**FAQ Integration Example (in ConversationService or MessageThreadViewModel):**
```swift
import Foundation
import FirebaseDatabase

@MainActor
final class ConversationService: ObservableObject {
    private let aiService: AIService

    init(aiService: AIService) {
        self.aiService = aiService
    }

    func observeMessages(conversationId: String) {
        // Existing observer code...

        messagesRef.observe(.childAdded) { snapshot in
            guard let message = self.parseMessage(snapshot) else { return }

            // Add message to local storage
            self.messages.append(message)

            // FAQ Auto-Response: Check if message is TO creator
            if message.receiverId == Constants.CREATOR_UID &&
               message.senderId != Constants.CREATOR_UID {
                Task {
                    await self.checkAndRespondToFAQ(message, conversationId: conversationId)
                }
            }
        }
    }

    private func checkAndRespondToFAQ(_ message: MessageEntity, conversationId: String) async {
        do {
            let faqResponse = try await aiService.checkFAQ(message.text)

            if faqResponse.isFAQ, let answer = faqResponse.answer {
                // Auto-send FAQ answer
                await sendMessage(
                    text: answer,
                    conversationId: conversationId,
                    senderId: Constants.CREATOR_UID,
                    receiverId: message.senderId,
                    isAIGenerated: true
                )
            }
        } catch {
            // Silent failure - don't disrupt user experience
            print("FAQ check failed: \(error)")
        }
    }

    private func sendMessage(
        text: String,
        conversationId: String,
        senderId: String,
        receiverId: String,
        isAIGenerated: Bool = false
    ) async {
        // Existing send message logic...
        // Make sure to include isAIGenerated parameter
    }
}
```

### Testing

**Testing Approach:**
1. Use two test accounts: creator (andrewsheim@gmail.com) and fan account
2. Login as fan account
3. Send FAQ questions to creator
4. Verify auto-responses appear
5. Check Firebase Console to see messages in RTDB

**Test Cases:**
- FAQ match: "What time do you stream?" → Auto-response appears
- FAQ paraphrase: "When do you go live?" → Auto-response appears
- Non-FAQ: "Random question" → No auto-response
- Creator sends message: No FAQ check happens
- Network error: Message sends, FAQ fails silently
- Multiple messages: All FAQ checks work independently

**Expected Behavior:**
- Fan sends FAQ question → Creator's response appears within 1-2 seconds
- Response is marked with AI badge (sparkles icon)
- Fan can continue conversation normally
- Creator sees the auto-response in their inbox

**Testing Standards** [Source: architecture/testing-strategy.md - assumed]
- Manual testing with two accounts
- Test FAQ matching accuracy
- Test error handling (network issues)
- Verify UI displays AI badge correctly
- No unit tests required for this story

### Important Notes

- This story completes the FAQ Auto-Responder feature end-to-end
- Depends on Story 6.3 (Cloud Function), Story 6.5 (AIService), Story 6.6 (Message Model)
- Required for Story 6.9 (AI Settings UI) to work
- FAQ toggle in Story 6.9 will disable this auto-response logic
- Silent failure ensures messages always send even if AI fails
- Only fan messages trigger FAQ checks (prevents loops)

### Prerequisites

- Story 6.3 (FAQ Cloud Function) must be deployed
- Story 6.5 (AIService) must be complete
- Story 6.6 (Message Model Updates) must be complete
- AIService.checkFAQ() method must exist
- MessageEntity must have isAIGenerated field
- ConversationService or MessageThreadViewModel must exist

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial story creation - fills gap between 6.3 and 6.9 | Product Owner (Sarah) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be populated by dev agent*

### Debug Log References

*To be populated by dev agent*

### Completion Notes

*To be populated by dev agent*

### File List

*To be populated by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
