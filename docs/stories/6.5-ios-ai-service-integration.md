# Story 6.5: iOS AI Service Integration

## Status
Draft

## Story
**As a** developer,
**I want** a clean AIService layer so all AI features are centralized and testable,
**so that** iOS views and ViewModels can easily call Cloud Functions for AI features.

## Acceptance Criteria
1. AIService created with FAQ and Smart Replies features
2. Clean async/await API
3. Uses Firebase Functions SDK (not direct HTTP)
4. Injectable via @EnvironmentObject for testing
5. Proper error handling (throws)
6. No hardcoded URLs (uses Firebase SDK)

## Tasks / Subtasks

- [ ] Verify Firebase Functions SDK (prerequisite)
  - [ ] Check `Package.swift` or Xcode project for Firebase dependencies
  - [ ] Verify `FirebaseFunctions` is included in project dependencies
  - [ ] Verify Firebase is initialized in app (check buzzboxApp.swift or AppDelegate)
  - [ ] If missing, add Firebase Functions to project via SPM
  - [ ] Build project to ensure no dependency errors

- [ ] Verify or create Services directory
  - [ ] Check if `buzzbox/Core/Services/` directory exists
  - [ ] If not, create directory in Xcode
  - [ ] Check if other services exist (AuthService, RealtimeDBService, etc.)
  - [ ] Follow existing service file naming patterns
  - [ ] Document actual directory structure

- [ ] Define AIService protocol (AC: 4)
  - [ ] Create protocol `AIServiceProtocol` in same file
  - [ ] Protocol methods: `checkFAQ(_:)` and `generateSmartReplies(conversationId:messageText:)`
  - [ ] Both methods use `async throws` signature
  - [ ] This enables dependency injection and testing
  - [ ] AIService class will conform to this protocol

- [ ] Define AIService error types (AC: 5)
  - [ ] Create enum `AIServiceError: Error`
  - [ ] Cases: `networkError`, `invalidResponse`, `functionNotFound`, `authenticationFailed`
  - [ ] Add `localizedDescription` for each error case
  - [ ] Use these errors in service methods instead of generic errors

- [ ] Create AIService class (AC: 1)
  - [ ] Create file: `buzzbox/Core/Services/AIService.swift`
  - [ ] Import Foundation and FirebaseFunctions
  - [ ] Mark class as `@MainActor` for UI thread safety
  - [ ] Conform to `ObservableObject` and `AIServiceProtocol`
  - [ ] Initialize Firebase Functions instance

- [ ] Define response data structures (AC: 1)
  - [ ] Create `FAQResponse` struct conforming to Codable
  - [ ] Fields: `isFAQ: Bool`, `answer: String?`, `matchedQuestion: String?`
  - [ ] Create `SmartReplyResponse` struct conforming to Codable
  - [ ] Nested `Drafts` struct with `short`, `medium`, `detailed` strings

- [ ] Implement checkFAQ method (AC: 1, 2, 3, 5)
  - [ ] Method signature: `func checkFAQ(_ text: String) async throws -> FAQResponse`
  - [ ] Verify user is authenticated (optional - Cloud Functions will handle)
  - [ ] Call `functions.httpsCallable("checkFAQ").call(["text": text])`
  - [ ] Convert result.data to JSON using JSONSerialization
  - [ ] Decode JSON to FAQResponse using JSONDecoder
  - [ ] Catch Firebase errors and wrap in AIServiceError
  - [ ] Return decoded response
  - [ ] Note: This method now fails silently (returns isFAQ: false) per Story 6.8

- [ ] Implement generateSmartReplies method (AC: 1, 2, 3)
  - [ ] Method signature: `func generateSmartReplies(conversationId: String, messageText: String) async throws -> [String]`
  - [ ] Call `functions.httpsCallable("generateSmartReplies").call(["conversationId": conversationId, "messageText": messageText])`
  - [ ] Convert result.data to JSON using JSONSerialization
  - [ ] Decode JSON to SmartReplyResponse using JSONDecoder
  - [ ] Extract drafts array: `[response.drafts.short, response.drafts.medium, response.drafts.detailed]`
  - [ ] Return array of 3 drafts

- [ ] Add error handling (AC: 5)
  - [ ] Both methods use `async throws` for error propagation
  - [ ] Let Firebase Functions SDK errors bubble up naturally
  - [ ] Calling code will catch and handle errors
  - [ ] No silent failures - always throw errors to caller

- [ ] Inject AIService into app (AC: 4)
  - [ ] Verify `buzzbox/App/buzzboxApp.swift` exists
  - [ ] Check file has @main attribute and WindowGroup
  - [ ] Check ContentView exists and is used
  - [ ] Create `@StateObject private var aiService = AIService()`
  - [ ] Add `.environmentObject(aiService)` to ContentView
  - [ ] Build project to verify no compilation errors
  - [ ] AIService is now accessible to all views via `@EnvironmentObject`

- [ ] Add documentation comments (AC: 6)
  - [ ] Add file header documentation explaining AIService purpose
  - [ ] Document each method with `///` Swift doc comments
  - [ ] Include parameters, return values, and throws documentation
  - [ ] Note: Auto-processing (categorization, sentiment, scoring) happens automatically via Cloud Function triggers

## Dev Notes

### Architecture Context

**MVVM Architecture** [Source: architecture/application-layers.md#5.1]
- Service Layer uses async/await for all operations
- Service Layer is protocol-based for testability
- ViewModels orchestrate Service layer calls
- Views never access Services directly (only via ViewModels)

**Dependency Injection** [Source: architecture/application-layers.md#5.2]
- All services use protocol-based dependency injection
- Services injected via @EnvironmentObject
- Enables parallel development and comprehensive testing

**iOS Technologies** [Source: architecture/technology-stack.md#2.1]
- Language: Swift 6
- Concurrency: Swift Concurrency (async/await, @MainActor)
- Package Manager: Swift Package Manager (SPM)
- Networking: URLSession (but Firebase Functions SDK for callable functions)

**Firebase Functions SDK** [Source: architecture/technology-stack.md#2.4]
- Firebase iOS SDK 10.20+
- Use Functions SDK for callable functions (not raw URLSession)
- SDK handles authentication, retry logic, and error handling

### File Locations

**New File to Create:**
```
buzzbox/
└── Core/
    └── Services/
        └── AIService.swift  (create this file)
```

**File to Modify:**
```
buzzbox/
└── App/
    └── buzzboxApp.swift  (inject AIService)
```

### Implementation Template

**AIService.swift Structure:**
```swift
import Foundation
import FirebaseFunctions

/// AI service for Firebase Cloud Functions integration
/// Handles FAQ auto-responder and smart reply generation
/// Note: Auto-processing (categorization, sentiment, scoring) happens automatically via Cloud Function triggers
@MainActor
final class AIService: ObservableObject {

    // MARK: - Configuration

    private let functions = Functions.functions()

    // MARK: - FAQ Auto-Responder (Feature 3)

    struct FAQResponse: Codable {
        let isFAQ: Bool
        let answer: String?
        let matchedQuestion: String?
    }

    /// Check if message matches FAQ and return auto-response
    func checkFAQ(_ text: String) async throws -> FAQResponse {
        let result = try await functions.httpsCallable("checkFAQ")
            .call(["text": text])

        let data = try JSONSerialization.data(withJSONObject: result.data)
        return try JSONDecoder().decode(FAQResponse.self, from: data)
    }

    // MARK: - Context-Aware Smart Replies (Feature 2 + Advanced)

    struct SmartReplyResponse: Codable {
        struct Drafts: Codable {
            let short: String
            let medium: String
            let detailed: String
        }
        let drafts: Drafts
    }

    /// Generate 3 context-aware smart replies in creator's voice
    func generateSmartReplies(
        conversationId: String,
        messageText: String
    ) async throws -> [String] {
        let result = try await functions.httpsCallable("generateSmartReplies")
            .call([
                "conversationId": conversationId,
                "messageText": messageText
            ])

        let data = try JSONSerialization.data(withJSONObject: result.data)
        let response = try JSONDecoder().decode(SmartReplyResponse.self, from: data)

        return [response.drafts.short, response.drafts.medium, response.drafts.detailed]
    }
}
```

**App Injection (buzzboxApp.swift):**
```swift
@main
struct buzzboxApp: App {
    @StateObject private var aiService = AIService()

    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(aiService)
        }
    }
}
```

### Integration Points

**How ViewModels will use AIService:**

Story 6.6 will update MessageThreadViewModel to:
- Call `aiService.checkFAQ()` when receiving messages
- Auto-send FAQ responses if matched

Story 6.7 will add SmartReplyPickerView:
- Call `aiService.generateSmartReplies()` when user taps "Draft Reply"
- Display 3 options to user

### Testing

**Testing Approach:**
1. Build and run iOS app
2. Verify AIService is initialized (no crashes)
3. Integration testing happens in Stories 6.6 and 6.7
4. Unit testing can be added later (would require protocol abstraction)

**Testing Standards** [Source: architecture/testing-strategy.md - assumed]
- Manual testing via iOS app build
- Integration testing in subsequent stories
- Protocol-based design enables future unit testing
- No unit tests required for this story

### Important Notes

- This story creates the service layer ONLY
- No UI changes in this story
- No ViewModel changes in this story
- Integration with message flow happens in Story 6.6
- Integration with Smart Reply UI happens in Story 6.7
- Auto-processing (categorization, sentiment, scoring) is automatic via Cloud Function triggers - no iOS code needed for that

### Coding Standards

**Swift 6 Concurrency:**
- Use `async/await` for all network calls
- Mark class as `@MainActor` for UI safety
- Use `throws` for error propagation (no completion handlers)

**SwiftUI Best Practices:**
- Service conforms to `ObservableObject` for reactivity
- Inject via `@EnvironmentObject` for app-wide access
- ViewModels access via `@EnvironmentObject var aiService: AIService`

**Error Handling:**
- Let Firebase SDK errors propagate naturally
- Calling code (ViewModels) will catch and display errors
- No silent failures - always throw errors up the chain

### Prerequisites

- Stories 6.0-6.4 (Cloud Functions) must be deployed
- Firebase Functions SDK must be installed (already in project)
- Firebase must be initialized in app (already done)
- Cloud Functions must be accessible from iOS app

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-22 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be populated by dev agent*

### Debug Log References

*To be populated by dev agent*

### Completion Notes

*To be populated by dev agent*

### File List

*To be populated by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
