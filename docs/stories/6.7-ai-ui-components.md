# Story 6.7: AI UI Components

## Status
Draft

## Story
**As** Andrew (the creator),
**I want** to see AI insights visually,
**so that** I can quickly triage messages based on category, sentiment, and business opportunity.

## Acceptance Criteria
1. AI badges show category, sentiment, score
2. Color-coded for quick visual scanning
3. Icons match category type
4. AI-generated badge for FAQ responses
5. Only shows on creator's view of fan messages
6. Looks good in light and dark mode
7. Animates in when AI metadata arrives
8. Smart reply picker shows 3 options
9. "Draft Reply" button in message composer
10. Loading state while generating smart replies

## Tasks / Subtasks

- [ ] Verify required files and properties (prerequisite)
  - [ ] Confirm `buzzbox/Features/Messages/Views/MessageBubbleView.swift` exists
  - [ ] Confirm `buzzbox/Features/Messages/Views/MessageThreadView.swift` exists
  - [ ] Check if MessageThreadViewModel has `isCreator` property
  - [ ] Check if MessageThreadViewModel has `lastMessage` property
  - [ ] If properties missing, add them as prerequisite tasks
  - [ ] Document actual file locations and ViewModel structure

- [ ] Add creator detection to MessageThreadViewModel (prerequisite)
  - [ ] Open MessageThreadViewModel or create computed property
  - [ ] Add: `var isCreator: Bool { currentUserId == Constants.CREATOR_UID }`
  - [ ] Requires access to current user ID (from AuthService or similar)
  - [ ] Import Constants file for CREATOR_UID (from Story 6.3.5)
  - [ ] Build to verify no errors

- [ ] Add lastMessage property to MessageThreadViewModel (prerequisite)
  - [ ] Add computed property: `var lastMessage: MessageEntity? { messages.last }`
  - [ ] Handle case where messages array is empty (returns nil)
  - [ ] This enables smart reply generation from most recent message
  - [ ] Build to verify property is accessible

- [ ] Create AIMetadataBadgeView component (AC: 1, 2, 3)
  - [ ] Create file: `buzzbox/Core/Views/Components/AIMetadataBadgeView.swift`
  - [ ] Accept parameters: `category: String?`, `sentiment: String?`, `score: Int?`
  - [ ] Display category badge with icon and text
  - [ ] Display sentiment as colored circle indicator
  - [ ] Display opportunity score for business messages only
  - [ ] Use HStack with spacing: 8

- [ ] Implement category badge styling (AC: 2, 3)
  - [ ] Create `categoryBadge(_ category: String)` helper method
  - [ ] Map categories to icons:
    - fan ‚Üí "heart.fill"
    - business ‚Üí "briefcase.fill"
    - spam ‚Üí "trash.fill"
    - urgent ‚Üí "exclamationmark.triangle.fill"
  - [ ] Map categories to colors:
    - fan ‚Üí .blue
    - business ‚Üí .purple
    - spam ‚Üí .gray
    - urgent ‚Üí .red
  - [ ] Use Label with icon, padding, background, cornerRadius

- [ ] Implement sentiment indicator styling (AC: 2)
  - [ ] Create `sentimentBadge(_ sentiment: String)` helper method
  - [ ] Display as filled circle with color:
    - positive ‚Üí .green
    - negative ‚Üí .red
    - urgent ‚Üí .orange
    - neutral ‚Üí .gray
  - [ ] Circle size: 8x8 points
  - [ ] Add subtle stroke overlay

- [ ] Implement opportunity score badge (AC: 1, 2)
  - [ ] Create `scoreBadge(_ score: Int)` helper method
  - [ ] Display star icon + score number
  - [ ] Color-code by score:
    - 80-100 ‚Üí .green (high value)
    - 50-79 ‚Üí .orange (medium value)
    - 0-49 ‚Üí .red (low value)
  - [ ] Only show if category is "business"

- [ ] Define message ownership logic in MessageBubbleView
  - [ ] Add computed property: `var isFromCurrentUser: Bool`
  - [ ] Compare message.senderID with current user ID
  - [ ] Requires access to AuthService or current user context
  - [ ] AI badges should show when: `!isFromCurrentUser && message.aiCategory != nil`
  - [ ] This ensures badges only appear on fan messages viewed by creator

- [ ] Update MessageBubbleView to display AI badges (AC: 5, 7)
  - [ ] Open `buzzbox/Features/Messages/Views/MessageBubbleView.swift`
  - [ ] Add AIMetadataBadgeView below message text
  - [ ] Only show for messages FROM fans (not from creator)
  - [ ] Check: `if !isFromCurrentUser, let category = message.aiCategory`
  - [ ] Add animation: `.transition(.opacity.combined(with: .scale))`
  - [ ] Build and test to verify badges appear correctly

- [ ] Add AI-generated indicator (AC: 4)
  - [ ] In MessageBubbleView, check `if message.isAIGenerated`
  - [ ] Display Label: "AI Response", systemImage: "sparkles"
  - [ ] Font: `.caption2`, foregroundStyle: `.secondary`
  - [ ] Position below message text, above timestamp

- [ ] Create SmartReplyPickerView (AC: 8)
  - [ ] Create file: `buzzbox/Core/Views/Components/SmartReplyPickerView.swift`
  - [ ] Accept parameters: `drafts: [String]`, `onSelect: (String) -> Void`, `onDismiss: () -> Void`
  - [ ] Display title: "‚ú® AI-Generated Replies"
  - [ ] ForEach over drafts with index
  - [ ] Each draft shows:
    - Label: "üìù Short" / "üí¨ Medium" / "üìÑ Detailed"
    - Character count: "\(draft.count) chars"
    - Draft text (multiline, leading alignment)
  - [ ] Button style: plain with background color
  - [ ] Add "Dismiss" button at bottom

- [ ] Integrate smart reply picker in MessageThreadView (AC: 9, 10)
  - [ ] Open `buzzbox/Features/Messages/Views/MessageThreadView.swift`
  - [ ] Add state variables:
    - `@State private var showSmartReplies = false`
    - `@State private var smartReplyDrafts: [String] = []`
    - `@State private var isLoadingDrafts = false`
  - [ ] Add "Draft Reply" button in message composer HStack
  - [ ] Only show if user is creator (check user type)
  - [ ] Button label: "Draft Reply", systemImage: "sparkles"
  - [ ] Show ProgressView while loading

- [ ] Implement smart reply generation flow (AC: 10)
  - [ ] Inject AIService via @EnvironmentObject
  - [ ] On button tap, start Task:
    - Set `isLoadingDrafts = true`
    - Call `aiService.generateSmartReplies(conversationId:messageText:)`
    - Validate response: check `result.count == 3`
    - Validate each draft is non-empty string
    - If validation fails, show error: "Failed to generate complete replies"
    - Don't show picker sheet if validation fails
    - Set `smartReplyDrafts = result` (only if valid)
    - Set `showSmartReplies = true` (only if valid)
    - Catch errors and show error alert
    - Set `isLoadingDrafts = false` in all paths (use defer)
  - [ ] Disable button while loading

- [ ] Handle missing ViewModel properties gracefully
  - [ ] If ViewModel.isCreator doesn't exist, compute manually
  - [ ] Fallback: check `currentUser.id == Constants.CREATOR_UID`
  - [ ] If ViewModel.lastMessage doesn't exist, use `messages.last`
  - [ ] Add TODO comments to refactor when ViewModel is updated
  - [ ] This ensures story can be implemented even if ViewModel isn't ready

- [ ] Add smart reply sheet presentation
  - [ ] Use `.sheet(isPresented: $showSmartReplies)`
  - [ ] Present SmartReplyPickerView
  - [ ] onSelect: populate message text field with selected draft
  - [ ] onDismiss: close sheet
  - [ ] Presentation detents: `.medium` and `.large`

- [ ] Test dark mode compatibility (AC: 6)
  - [ ] Run app in light mode - verify colors look good
  - [ ] Run app in dark mode - verify colors adapt correctly
  - [ ] Use semantic colors (Color.primary, Color.secondary) where appropriate
  - [ ] Test all badge types in both modes

- [ ] Test animations (AC: 7)
  - [ ] Send test message and wait for AI metadata
  - [ ] Verify badges animate in smoothly
  - [ ] Test smart reply picker presentation animation
  - [ ] Ensure no janky animations

## Dev Notes

### Architecture Context

**MVVM Architecture** [Source: architecture/application-layers.md#5.1]
- View Layer: Pure SwiftUI views, no business logic
- Views subscribe to ViewModels via @Published properties
- Send user actions to ViewModel methods

**SwiftUI Best Practices** [Source: CLAUDE.md]
- Extract complex SwiftUI views into separate structs
- Use semantic colors for dark mode support
- Use `@ViewBuilder` for conditional view composition
- Use `.transition()` for smooth animations

**Navigation** [Source: architecture/application-layers.md#5.3]
- Sheet presentation for modals
- Use `.presentationDetents()` for half-sheet Smart Reply picker

### File Locations

**New Files to Create:**
- `buzzbox/Core/Views/Components/AIMetadataBadgeView.swift`
- `buzzbox/Core/Views/Components/SmartReplyPickerView.swift`

**Files to Modify:**
- `buzzbox/Features/Messages/Views/MessageBubbleView.swift` - Add AI badges
- `buzzbox/Features/Messages/Views/MessageThreadView.swift` - Add Draft Reply button and smart reply flow

### Component Specifications

**AIMetadataBadgeView Structure:**
```swift
struct AIMetadataBadgeView: View {
    let category: String?
    let sentiment: String?
    let score: Int?

    var body: some View {
        HStack(spacing: 8) {
            if let category {
                categoryBadge(category)
            }

            if let sentiment {
                sentimentBadge(sentiment)
            }

            if let score, category == "business" {
                scoreBadge(score)
            }
        }
        .font(.caption2)
    }

    // Helper methods for styling...
}
```

**SmartReplyPickerView Structure:**
```swift
struct SmartReplyPickerView: View {
    let drafts: [String]
    let onSelect: (String) -> Void
    let onDismiss: () -> Void

    var body: some View {
        VStack(spacing: 16) {
            Text("‚ú® AI-Generated Replies")
                .font(.headline)

            ForEach(Array(drafts.enumerated()), id: \.offset) { index, draft in
                Button {
                    onSelect(draft)
                } label: {
                    VStack(alignment: .leading, spacing: 8) {
                        HStack {
                            Text(draftLabel(index))
                                .font(.caption)
                                .foregroundStyle(.secondary)
                            Spacer()
                            Text("\(draft.count) chars")
                                .font(.caption2)
                                .foregroundStyle(.tertiary)
                        }
                        Text(draft)
                            .font(.body)
                            .multilineTextAlignment(.leading)
                            .foregroundStyle(.primary)
                    }
                    .padding()
                    .background(Color(.systemGray6))
                    .cornerRadius(12)
                }
                .buttonStyle(.plain)
            }

            Button("Dismiss", action: onDismiss)
                .font(.footnote)
        }
        .padding()
    }

    func draftLabel(_ index: Int) -> String {
        ["üìù Short", "üí¨ Medium", "üìÑ Detailed"][index]
    }
}
```

**MessageThreadView Smart Reply Integration:**
```swift
struct MessageThreadView: View {
    @StateObject private var viewModel: MessageThreadViewModel
    @EnvironmentObject private var aiService: AIService

    @State private var showSmartReplies = false
    @State private var smartReplyDrafts: [String] = []
    @State private var isLoadingDrafts = false
    @State private var messageText = ""

    var body: some View {
        VStack {
            messageListView

            HStack {
                if viewModel.isCreator {
                    Button {
                        Task {
                            isLoadingDrafts = true
                            do {
                                smartReplyDrafts = try await aiService.generateSmartReplies(
                                    conversationId: viewModel.conversationId,
                                    messageText: viewModel.lastMessage?.text ?? ""
                                )
                                showSmartReplies = true
                            } catch {
                                // Show error toast
                                print("Failed to generate drafts: \(error)")
                            }
                            isLoadingDrafts = false
                        }
                    } label: {
                        if isLoadingDrafts {
                            ProgressView()
                        } else {
                            Label("Draft Reply", systemImage: "sparkles")
                        }
                    }
                    .disabled(isLoadingDrafts)
                }

                messageComposer
            }
        }
        .sheet(isPresented: $showSmartReplies) {
            SmartReplyPickerView(
                drafts: smartReplyDrafts,
                onSelect: { draft in
                    messageText = draft  // Populate composer
                    showSmartReplies = false
                },
                onDismiss: { showSmartReplies = false }
            )
            .presentationDetents([.medium, .large])
        }
    }
}
```

### Color Palette

**Category Colors:**
- Fan: `.blue` - Friendly, supportive interactions
- Business: `.purple` - Professional, collaboration opportunities
- Spam: `.gray` - Low priority, filtered
- Urgent: `.red` - Immediate attention required

**Sentiment Colors:**
- Positive: `.green` - Happy, supportive tone
- Negative: `.red` - Upset, complaint
- Urgent: `.orange` - Time-sensitive
- Neutral: `.gray` - Informational

**Opportunity Score Colors:**
- High (80-100): `.green` - Great opportunity
- Medium (50-79): `.orange` - Worth considering
- Low (0-49): `.red` - Low value

### Testing

**Testing Approach:**
1. Build and run iOS app
2. Send messages from fan account to creator
3. Verify AI badges appear within 1-2 seconds
4. Test all badge types (fan, business, spam, urgent)
5. Test smart reply generation
6. Test light and dark mode
7. Test animations

**Test Cases:**
- Fan message: Blue badge with heart icon, green sentiment dot
- Business message: Purple badge with briefcase icon, score badge visible
- Spam message: Gray badge with trash icon
- Urgent message: Red badge with warning icon
- FAQ auto-response: "AI Response" sparkles badge
- Smart replies: Tap "Draft Reply", verify 3 options appear
- Dark mode: Verify all colors adapt correctly

**Testing Standards** [Source: architecture/testing-strategy.md - assumed]
- Manual UI testing in simulator and device
- Test all badge combinations
- Test light and dark mode
- Test animations and transitions
- No unit tests required for UI components

### Important Notes

- This story makes AI features visible to users
- AI badges help creator prioritize responses
- Smart reply picker accelerates response workflow
- Colors are semantic and adapt to dark mode
- Animations provide smooth UX feedback
- Only creator sees AI badges (fans don't see them on their own messages)

### Prerequisites

- Story 6.5 (AIService) must be complete
- Story 6.6 (Message Model Updates) must be complete
- AI metadata must be flowing from Cloud Functions to iOS
- MessageBubbleView and MessageThreadView must exist

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-22 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be populated by dev agent*

### Debug Log References

*To be populated by dev agent*

### Completion Notes

*To be populated by dev agent*

### File List

*To be populated by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
