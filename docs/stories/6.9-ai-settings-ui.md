# Story 6.9: AI Settings UI

## Status
Draft

## Story
**As** Andrew (the creator),
**I want** to control AI behavior,
**so that** I can disable features I don't want and customize AI settings.

## Acceptance Criteria
1. AI Settings view created
2. Toggle for FAQ auto-response
3. Toggle for auto-processing (future: can disable Cloud Function)
4. Settings persist via @AppStorage
5. FAQ auto-response respects toggle
6. Accessible from main settings

## Tasks / Subtasks

- [ ] Verify SettingsView exists and structure (prerequisite)
  - [ ] Confirm `buzzbox/Features/Settings/Views/SettingsView.swift` exists
  - [ ] Check existing sections in SettingsView
  - [ ] Identify best section for AI Settings NavigationLink
  - [ ] Document current SettingsView structure

- [ ] Verify Constants file exists (prerequisite)
  - [ ] Confirm `buzzbox/Core/Utilities/Constants.swift` exists (from Story 6.3.5)
  - [ ] Verify CREATOR_UID constant is accessible
  - [ ] If missing, must complete Story 6.3.5 first
  - [ ] Import Constants in files that need CREATOR_UID

- [ ] Create AISettingsView (AC: 1)
  - [ ] Create file: `buzzbox/Features/Settings/Views/AISettingsView.swift`
  - [ ] Use Form layout with sections
  - [ ] Navigation title: "AI Settings"
  - [ ] Navigation bar title display mode: `.inline`

- [ ] Add FAQ auto-response toggle (AC: 2, 4)
  - [ ] Create @AppStorage property: `@AppStorage("ai.faqAutoResponse.enabled") private var faqAutoResponseEnabled = true`
  - [ ] Add Section with header: "Auto-Response"
  - [ ] Add Toggle: "FAQ Auto-Response", isOn: `$faqAutoResponseEnabled`
  - [ ] Add descriptive Text: "Automatically send FAQ answers when fans ask common questions"
  - [ ] Text font: `.caption`, foregroundStyle: `.secondary`

- [ ] Add auto-processing status (informational only) (AC: 3)
  - [ ] Remove @AppStorage for auto-processing (not needed)
  - [ ] Add Section with header: "AI Processing"
  - [ ] Add VStack with:
    - Text("Auto-Categorization").font(.headline)
    - Text("Enabled (always on)").font(.caption).foregroundStyle(.secondary)
    - Text("Messages are automatically analyzed with AI for categorization, sentiment, and scoring").font(.caption).foregroundStyle(.secondary)
  - [ ] This is read-only status, not a toggle
  - [ ] Cloud Functions always run (can't be disabled from iOS)

- [ ] Add manual features section (AC: 1)
  - [ ] Add Section with header: "Manual Features"
  - [ ] Add VStack with:
    - Text("Smart Replies").font(.headline)
    - Text("Always available via 'Draft Reply' button").font(.caption).foregroundStyle(.secondary)
  - [ ] This section is informational (smart replies are always available)

- [ ] Integrate FAQ toggle in FAQ integration code (AC: 5)
  - [ ] Open FAQ integration code (Story 6.3.5)
  - [ ] This could be in ConversationService or MessageThreadViewModel
  - [ ] Add @AppStorage property: `@AppStorage("ai.faqAutoResponse.enabled") private var faqAutoResponseEnabled = true`
  - [ ] Find FAQ check logic (where aiService.checkFAQ is called)
  - [ ] Wrap FAQ check in: `if faqAutoResponseEnabled && message.receiverId == Constants.CREATOR_UID { ... }`
  - [ ] Only check FAQ if toggle is enabled
  - [ ] Include null check: only process if message text is not empty
  - [ ] Log when FAQ check is skipped due to toggle being off

- [ ] Add navigation link in SettingsView (AC: 6)
  - [ ] Open `buzzbox/Features/Settings/Views/SettingsView.swift`
  - [ ] Add NavigationLink in appropriate section:
  - [ ] NavigationLink { AISettingsView() } label: { Label("AI Settings", systemImage: "sparkles") }
  - [ ] Position in settings list (likely in "Preferences" section)

- [ ] Test settings persistence
  - [ ] Toggle FAQ auto-response OFF
  - [ ] Close and reopen app
  - [ ] Verify toggle is still OFF (persisted)
  - [ ] Send FAQ question from fan
  - [ ] Verify NO auto-response sent
  - [ ] Toggle FAQ auto-response ON
  - [ ] Send FAQ question again
  - [ ] Verify auto-response IS sent

- [ ] Test auto-processing toggle (informational)
  - [ ] Toggle auto-processing OFF
  - [ ] Send message
  - [ ] Verify AI processing still happens (Cloud Function always runs)
  - [ ] Note: This toggle is informational only (future enhancement)

## Dev Notes

### Architecture Context

**SwiftUI State Management** [Source: CLAUDE.md]
- `@AppStorage` for persisting simple settings (UserDefaults)
- Values persist across app launches
- Automatically updates UI when values change

**Navigation** [Source: architecture/application-layers.md#5.3]
- Sheet presentation for modals
- NavigationLink for hierarchical navigation
- AI Settings accessed via NavigationLink from main Settings

### File Locations

**New File to Create:**
- `buzzbox/Features/Settings/Views/AISettingsView.swift`

**Files to Modify:**
- `buzzbox/Features/Settings/Views/SettingsView.swift` - Add navigation link
- `buzzbox/Features/Messages/ViewModels/MessageThreadViewModel.swift` - Respect FAQ toggle

### Implementation Template

**AISettingsView.swift:**
```swift
import SwiftUI

struct AISettingsView: View {
    @AppStorage("ai.faqAutoResponse.enabled") private var faqAutoResponseEnabled = true

    var body: some View {
        Form {
            Section {
                Toggle("FAQ Auto-Response", isOn: $faqAutoResponseEnabled)
                Text("Automatically send FAQ answers when fans ask common questions")
                    .font(.caption)
                    .foregroundStyle(.secondary)
            } header: {
                Text("Auto-Response")
            }

            Section {
                VStack(alignment: .leading, spacing: 8) {
                    Text("Auto-Categorization")
                        .font(.headline)
                    Text("Enabled (always on)")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                    Text("Messages are automatically analyzed with AI for categorization, sentiment, and scoring")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }
            } header: {
                Text("AI Processing")
            }

            Section {
                VStack(alignment: .leading, spacing: 8) {
                    Text("Smart Replies")
                        .font(.headline)
                    Text("Always available via 'Draft Reply' button")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }
            } header: {
                Text("Manual Features")
            }
        }
        .navigationTitle("AI Settings")
        .navigationBarTitleDisplayMode(.inline)
    }
}
```

**FAQ Integration (ConversationService or MessageThreadViewModel):**
```swift
import Foundation

@MainActor
final class ConversationService: ObservableObject {
    @AppStorage("ai.faqAutoResponse.enabled") private var faqAutoResponseEnabled = true
    private let aiService: AIService

    func checkAndRespondToFAQ(_ message: MessageEntity, conversationId: String) async {
        // Only check FAQ if enabled in settings AND message is to creator
        guard faqAutoResponseEnabled,
              message.receiverId == Constants.CREATOR_UID,
              !message.text.isEmpty else {
            return
        }

        do {
            let faqResponse = try await aiService.checkFAQ(message.text)

            if faqResponse.isFAQ, let answer = faqResponse.answer {
                await sendMessage(
                    text: answer,
                    conversationId: conversationId,
                    isAIGenerated: true
                )
            }
        } catch {
            print("FAQ check failed: \(error)")
        }
    }
}
```

**SettingsView Integration:**
```swift
// In SettingsView.swift, add this NavigationLink:

NavigationLink {
    AISettingsView()
} label: {
    Label("AI Settings", systemImage: "sparkles")
}
```

### @AppStorage Keys

**Defined Keys:**
- `ai.faqAutoResponse.enabled` - Boolean, default: true
- `ai.autoProcessing.enabled` - Boolean, default: true (informational only)

**Why @AppStorage:**
- Simple boolean settings
- Automatic persistence to UserDefaults
- Automatic UI updates when changed
- No need for custom persistence layer

### Settings Behavior

**FAQ Auto-Response Toggle:**
- ON (default): FAQ questions get auto-responses
- OFF: FAQ questions are not checked, no auto-responses

**Auto-Processing Toggle:**
- Informational only (for now)
- Cloud Functions always process messages (can't be disabled from iOS)
- Future enhancement: Could send flag to Cloud Function to skip processing

**Smart Replies:**
- Always available (no toggle)
- User-initiated via "Draft Reply" button
- No reason to disable (manual action)

### Testing

**Testing Approach:**
1. Build and run iOS app
2. Navigate to Settings > AI Settings
3. Toggle FAQ auto-response OFF
4. Send FAQ question, verify no auto-response
5. Toggle FAQ auto-response ON
6. Send FAQ question, verify auto-response appears
7. Close and reopen app
8. Verify toggle state persisted

**Test Cases:**
- FAQ toggle ON: Verify auto-responses work
- FAQ toggle OFF: Verify no auto-responses
- Persistence: Verify settings persist across app restarts
- UI: Verify settings screen looks good in light and dark mode
- Auto-processing toggle: Informational only, messages still processed

**Testing Standards** [Source: architecture/testing-strategy.md - assumed]
- Manual UI testing
- Test toggle behavior
- Test persistence
- No unit tests required for UI settings

### Important Notes

- This is a simple settings screen (30 min story)
- FAQ toggle actually controls behavior
- Auto-processing toggle is informational (future enhancement)
- Smart replies are always available (no toggle needed)
- Settings persist via UserDefaults (@AppStorage)
- All settings default to enabled (opt-out, not opt-in)

### Future Enhancements

**Possible Future Settings:**
- Smart reply tone preference (formal/casual/friendly)
- Auto-categorization threshold (confidence level)
- FAQ confidence threshold (current: implicit in GPT prompt)
- Notification preferences for high-value business messages
- AI voice customization (more examples)

### Prerequisites

- Story 6.3 (FAQ Auto-Responder) must be complete
- Story 6.5 (AIService) must be complete
- MessageThreadViewModel must have FAQ checking logic
- SettingsView must exist

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-22 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

*To be populated by dev agent*

### Debug Log References

*To be populated by dev agent*

### Completion Notes

*To be populated by dev agent*

### File List

*To be populated by dev agent*

## QA Results

*This section will be populated by the QA agent after story completion.*
